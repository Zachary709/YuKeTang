# 雨课堂刷课脚本

`course_app.py` 是一个命令行脚本，用于自动化雨课堂学习过程，核心流程包含二维码扫码登录、课程选择、自动发送视频心跳记录以提升视频覆盖率，以及自动刷讨论区评论。脚本在单次运行期间保持统一的浏览器指纹，并带有日志、重试、进度监控等机制，旨在模拟更真实的观看行为。核心模块已拆分为：

- `src/auth/login_workflow.py`：扫码登录逻辑（WebSocket 获取二维码、保存 cookies）。
- `src/core/course_progress.py`：刷视频 + 刷讨论区评论的主要逻辑。
- `src/network/http_client.py`：`requests.Session` 会话与 UA/Referer 等指纹配置。
- `src/utils/logging_utils.py`：统一日志输出。
- `src/utils/config_utils.py`：读取 `config.yml` 中的配置。
- `src/llm/comment_generator.py`：基于 OpenAI 兼容接口（如阿里云百炼）的评论内容生成。

## 功能简介
- WebSocket 获取二维码，扫码后自动完成登录。
- 拉取课程列表，让用户手动选择需要刷的课堂。
- **自动刷视频**：
  - 自动遍历章节-小节，提取全部视频，并逐个完成；
  - 发送模拟心跳（`video-log/heartbeat`）并实时校验覆盖率，覆盖率未达 100% 时会回放补刷。
- **自动刷讨论区评论**：
  - 自动根据课程的 `sku_id` 调用进度接口（`score_detail`），筛选出所有讨论题；
  - 仅对 **leaf_type=4、evaluation_id=10 且 `user_score == 0`（尚未得分）** 的讨论题进行评论；
  - 对每个讨论题自动获取题目内容（`leaf_info` 接口中的 `content_info.context`）；
  - 根据配置选择：使用固定模板评论，或调用 LLM 自动生成个性化评论；
  - 若 LLM 生成失败（通常是题目内容较敏感），会在日志中输出对应讨论区网址，便于手动前往评论。
- 异常、进度、完成状态均通过统一日志输出，方便观察。

- **自动刷测试题**：
  - 自动检测课程中的测试（leaf_type=6），支持单选、多选、判断和填空题。
  - 仅处理尚未开始/未得分的测试（通过 `score_detail` 接口判断 `user_score == 0`），避免重复答题。
  - 对每道题使用 LLM（同样支持 OpenAI 兼容接口，如阿里云百炼）生成参考答案；**填空题准确率很低，不会自动提交**，脚本仅输出“仅供参考”的答案以便手动填入。
  - 对于有字体混淆的题目，会尝试下载并解析字体映射（缓存到 `font_cache/`），并对 HTML 中被加密的 span 进行解码；字体解析结果会被缓存以加速后续运行。
  - 答题时会在终端交互：选择要刷的测试（支持单个或全部），每次刷完会询问是否继续；所有生成的答案会做汇总展示，方便复制粘贴填写或保存。

## 环境要求
- Python 3.8+
- 依赖库（可用 `pip install <pkg>` 安装）：
  - `requests`：HTTP 客户端
  - `websockets`：扫码登录时的 WebSocket 支持
  - `openai` 或 任意 OpenAI 兼容客户端（用于调用 LLM），也可用阿里云 DashScope 的兼容接口通过 `requests` 调用
  - `Pillow`（PIL）：用于字体渲染（解析字体时生成图片供 OCR 识别）
  - `fonttools`：解析 TTF/WOFF 字体文件以提取 cmap
  - `ddddocr`：用于 OCR（识别字体映射），解析字体混淆
  - 其他：如需要运行 LLM 的官方 SDK（取决于你的 LLM 提供商）或额外依赖，请按实际情况安装

建议一次性安装（Windows PowerShell）：
```powershell
pip install requests websockets openai Pillow fonttools ddddocr
```

## 使用步骤
1. 运行脚本：`python course_app.py`
2. 等待终端弹出二维码提示，扫码并绑定对应的雨课堂账号。
3. 看到功能菜单：
  - `1. 自动刷视频`
  - `2. 自动刷讨论题评论`
  - `3. 自动刷测试题`
4. 选择功能后，终端会列出当前可用课程，输入序号即可开始：
   - 刷视频模式：每个视频都会实时显示进度、覆盖率；达到 100% 覆盖率后自动跳过。
  - 刷讨论题评论模式：只会处理当前课程中尚未得分的讨论题。
  - 刷测试题模式：进入后会显示可选的测试列表，支持按测试逐个或全部处理；脚本会尽量只处理尚未得分的测试并在每次处理后询问是否继续。
5. 完成后可选择是否继续其他操作或直接退出程序。

## 配置说明（`config.yml`）
项目根目录下的 `config.yml` 用于控制评论内容和 LLM 相关配置，示例：

```yaml
default_comment: "None"
DASHSCOPE_API_KEY: "YOUR_API_KEY_HERE"
LLM_BASE_URL: "https://dashscope.aliyuncs.com/compatible-mode/v1"
LLM_MODEL: "qwen3-max"
```

- `default_comment`：
  - 如果设置为字符串（如 `"该课程的学习让我受益匪浅。"`），刷讨论时将使用该固定模板作为评论内容，且每次评论前会随机 `sleep 3~8 秒` 以降低频率；
  - 如果设置为 `"None"`（不区分大小写），则对每个讨论题调用 LLM 自动生成评论内容。
- `DASHSCOPE_API_KEY`：用于访问阿里云百炼（DashScope）或其他 OpenAI 兼容服务的 API Key。
- `LLM_BASE_URL`：OpenAI 兼容接口的基地址，默认为阿里云百炼的兼容地址，若切换到官方 OpenAI 或其他厂商，请按需修改。
- `LLM_MODEL`：用于生成评论的模型名称，如 `qwen3-max`，可根据你的实际服务调整。

API KEY需要自己申请一下，建议使用阿里云百炼，这样模型和URL都可以直接用这里默认的。（截止2025年12月，这个模型还是有免费额度的，不用考虑付费的事）

LLM 生成评论时会自动：
- 解析讨论题的 HTML 题干为纯文本；
- 将 **课程名称** 和 **讨论题内容** 一并放入提示词；
- 要求模型严格输出 `<topic_text>你的评论</topic_text>` 格式，脚本只提取标签内的内容作为最终评论文本；
- 若连续多次未返回合法格式，会在日志中提示并输出对应讨论区 URL，方便你手动处理。

## 注意事项
- 仅适配雨课堂 PC 端接口，主要针对西电研究生的课程结构；其他账号请自行测试。
- 登录二维码默认保存在 `login_qr.png`，如需更改可修改源码对应部分。
- 若过程中出现网络波动，脚本会自动重试心跳；若仍失败可重新运行。
- **某些视频可能会显示“加载时长失败”**，一般是因为该视频是其他格式，雨课堂没有自动缓存，需要自己手动打开一下所有不能刷的视频，之后再开始刷课。
- 自动刷讨论区评论仅对当前 **未得分** 的讨论题生效，已经有分数的讨论题不会重复评论。
- 使用固定模板评论时已加入随机延时，但仍建议适度使用，避免过于频繁触发风控。

## 声明
本项目仅供学习研究，请勿用于任何违反校规或法律的用途。
